{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Register{% endblock title %}</title>
    <link rel="stylesheet" href="{% static 'styles/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'styles/logreg.css' %}">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <script src="{% static 'scripts/bootstrap.min.js' %}"></script>
    <script src="{% static 'scripts/jquery-3.7.1.min.js' %}"></script>
</head>
<body>
    {% block content %}
        <div class="container-fluid shadow-lg p-3 mb-5 bg-body-tertiary rounded" id="mainPage">
            <h2>Register as new user</h2>
            <form action="{% url 'login' %}" method="post">
                {% csrf_token %}
                <div>
                    <label for="fullname" id="fullnameLabel">Full Name:
                        <input type="text" name="fullname" class="form-control" placeholder="Full Name">
                    </label>
                    <label for="email" id="emailLabel">Email Address:
                        <input type="email" name="email" class="form-control" placeholder="name@example.com">
                    </label>
                    <p id="emailValidation"></p>
                    <label for="password" id="passwordLabel">Password:
                        <input type="password" name="password" class="form-control" placeholder="Password">
                        <i class='bx bx-show' id='showPassword' style="cursor: pointer; right: 8%;"></i>
                        <i class='bx bx-hide' id='hidePassword' style="cursor: pointer; right: 8%; display: none;"></i>
                    </label>
                </div>
                <div>
                    <span>Already an existing user? <a href="{% url 'login' %}">Login</a></span>
                </div>
                <div>
                    <button id="loginSubmit" class="btn btn-danger" type="submit">Create Account</button>
                </div>
            </form>
        </div>

        <script>
            $.getCookie = function (name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    $.each(cookies, function (i, cookie) {
                        cookie = $.trim(cookie);
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            return false; // break out of $.each loop
                        }
                    });
                }
                return cookieValue;
            };

            const csrftoken = $.getCookie('csrftoken');

            $(document).ready(function()    {
                const hidePassword = $('#hidePassword');
                const showPassword = $('#showPassword');
                const loginPassword = $('#passwordLabel input');

                //To show the password and change the type and logo
                showPassword.click(function () {
                    console.log("In Function showpassword now");
                    loginPassword.attr('type', 'text');
                    showPassword.css('display', 'none');
                    hidePassword.css('display', 'block');
                });

                //To hide the password and change the type and logo
                hidePassword.click(function () {
                    loginPassword.attr('type', 'password');
                    showPassword.css('display', 'block');
                    hidePassword.css('display', 'none');
                });

                $('#loginSubmit').click(function()  {
                    var inputs = $('#mainPage').find('input');
                    var data = { };

                    inputs.each(function()  {
                        var name = $(this).attr('name');
                        var value = $(this).val();
                        data[name] = value;
                    });
                    console.log(data);
                    debugger;

                    $.ajax({
                        type: 'POST',
                        url: '{% url "register_api" %}',
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        data: data,
                        success: function(response) {
                            if(response.status == '201' || response.status == 'success')    {
                                alert(response.messages);
                                debugger;
                            }
                        },
                        error: function(xhr)    {
                            const response = xhr.responseJSON;
                            if (response.errors) {
                                if (response.errors.email) {
                                    $('#emailValidation').innerText(response.errors.email);
                                    debugger;
                                }
                            }
                            else {
                                alert(response.message);
                                debugger;
                            }
                            window.location.href = '{% url "register" %}';
                        }
                    });
                });
            });
        </script>
    {% endblock content %}
</body>
</html>